<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carmen.NET System Architecture - Carmen.NET Documentation</title>
    <link rel="stylesheet" href="/public/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #212121;
            background: #f5f5f5;
            padding: 0;
            margin: 0;
        }
        .doc-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .doc-header {
            border-bottom: 2px solid #1976D2;
            padding-bottom: 16px;
            margin-bottom: 32px;
        }
        .doc-header h1 {
            margin: 0;
            color: #1976D2;
        }
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #1976D2;
            text-decoration: none;
            margin-bottom: 16px;
            font-weight: 600;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        .doc-content h1 {
            font-size: 2.5em;
            margin-top: 0;
            margin-bottom: 0.5em;
            color: #1f2937;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.3em;
        }
        .doc-content h2 {
            font-size: 2em;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            color: #1f2937;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.3em;
        }
        .doc-content h3 {
            font-size: 1.5em;
            margin-top: 1.2em;
            margin-bottom: 0.5em;
            color: #374151;
        }
        .doc-content h4 {
            font-size: 1.25em;
            margin-top: 1em;
            margin-bottom: 0.5em;
            color: #4b5563;
        }
        .doc-content p {
            line-height: 1.7;
            margin-bottom: 1em;
            color: #374151;
        }
        .doc-content ul, .doc-content ol {
            margin-bottom: 1em;
            padding-left: 2em;
        }
        .doc-content li {
            margin-bottom: 0.5em;
            line-height: 1.7;
        }
        .doc-content code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #e11d48;
        }
        .doc-content pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 1em;
        }
        .doc-content pre code {
            background: none;
            padding: 0;
            color: #f9fafb;
        }
        .doc-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1em;
        }
        .doc-content th, .doc-content td {
            border: 1px solid #e5e7eb;
            padding: 12px;
            text-align: left;
        }
        .doc-content th {
            background: #f9fafb;
            font-weight: 600;
        }
        .doc-content blockquote {
            border-left: 4px solid #3b82f6;
            padding-left: 16px;
            margin-left: 0;
            color: #6b7280;
            font-style: italic;
        }
        .doc-content a {
            color: #3b82f6;
            text-decoration: none;
        }
        .doc-content a:hover {
            text-decoration: underline;
        }
        .doc-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 1em 0;
        }
        .mermaid {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin: 1em 0;
            text-align: center;
            overflow-x: auto;
        }
        .mermaid svg {
            max-width: 100%;
            height: auto;
        }
        @media (max-width: 768px) {
            .doc-container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="doc-container">
        <a href="/public/index.html" class="back-link">
            <i class="fas fa-arrow-left"></i>
            Back to Documentation
        </a>
        <div class="doc-header">
            <h1>Carmen.NET System Architecture</h1>
        </div>
        <div class="doc-content">
            <h1>Carmen.NET System Architecture</h1>
<p><strong>Document Version</strong>: 1.0<br><strong>Last Updated</strong>: 2025-10-06<br><strong>Status</strong>: Phase 2 Complete</p>
<hr>
<h2>Executive Summary</h2>
<p>Carmen.NET is a comprehensive multi-tenant financial ERP system built on .NET Framework with ASP.NET Web API. The system implements a 3-tier architecture with strict separation of concerns, role-based access control, and multi-tenant data isolation. With 11 core modules, 351+ API endpoints, and 597 data models, the system provides complete financial management capabilities from accounts payable/receivable to asset management and financial reporting.</p>
<p><strong>Architecture Highlights</strong>:</p>
<ul>
<li><strong>3-Tier Architecture</strong>: Presentation (API) → Business Logic → Data Access</li>
<li><strong>Multi-Tenant</strong>: Isolated data and operations per tenant</li>
<li><strong>Security</strong>: Token-based authentication, RBAC, encryption</li>
<li><strong>Scalability</strong>: REST API design, stateless architecture</li>
<li><strong>Integration</strong>: 351+ REST endpoints, Excel/CSV, banking files</li>
</ul>
<hr>
<h2>1. System Context</h2>
<h3>1.1 System Landscape</h3>
<div class="mermaid">graph TB
    subgraph External["External Systems"]
        Banking[Banking Systems]
        Tax[Tax Authorities]
        Email[Email Services]
        Payment[Payment Gateways]
        Office[Excel/Office]
        Reporting[Reporting Services]
    end

    subgraph Carmen["Carmen.NET ERP"]
        AP[AP Module]
        AR[AR Module]
        GL[GL Module]
        Asset[Asset Module]
        Income[Income Module]
        TaxMod[Tax Module]
        Admin[System Administration<br/>& Security]
    end

    subgraph Users["Users"]
        Accountants
        Managers[Finance Managers]
        SysAdmins[System Admins]
        Auditors
        WebClients[Web Clients]
        ExcelUsers[Excel Add-ins]
        MobileUsers[Mobile Apps]
        APIUsers[API Users]
    end

    External --> Carmen
    Carmen --> Users

    style Carmen fill:#1168bd,stroke:#0b4884,color:#ffffff
    style External fill:#999999,stroke:#666666,color:#ffffff
    style Users fill:#08427b,stroke:#052e56,color:#ffffff</div><h3>1.2 System Scope</h3>
<p><strong>In Scope</strong>:</p>
<ul>
<li>✅ Financial accounting (AP, AR, GL)</li>
<li>✅ Asset management and depreciation</li>
<li>✅ Income and revenue recognition</li>
<li>✅ Tax management and compliance</li>
<li>✅ Financial reporting</li>
<li>✅ Multi-tenant operations</li>
<li>✅ User and permission management</li>
<li>✅ Workflow and approval processes</li>
</ul>
<p><strong>Out of Scope</strong>:</p>
<ul>
<li>❌ Human Resources Management</li>
<li>❌ Inventory Management (beyond asset tracking)</li>
<li>❌ Manufacturing/Production</li>
<li>❌ CRM functionality</li>
<li>❌ Supply Chain Management</li>
</ul>
<hr>
<h2>2. High-Level Architecture</h2>
<h3>2.1 Architectural Style</h3>
<p><strong>Primary Pattern</strong>: 3-Tier Layered Architecture<br><strong>Secondary Patterns</strong>: RESTful API, Multi-Tenant SaaS, RBAC</p>
<div class="mermaid">graph TD
    subgraph Presentation["Presentation Layer"]
        Controllers["60 API Controllers<br/>351+ Endpoints"]
        Auth["Authentication Controllers<br/>Login, Token"]
        ModuleCtrl["Module Controllers<br/>AP, AR, GL, Asset, Income"]
        AdminCtrl["Admin Controllers<br/>User, Role, Tenant, Config"]
        UtilCtrl["Utility Controllers<br/>Excel, File, Report"]
    end

    subgraph Business["Business Logic Layer"]
        Service["Service Layer<br/>(Inferred)"]
        BizRules["Business Rules:<br/>• Validation<br/>• Workflow Orchestration<br/>• Permission Enforcement<br/>• Multi-tenant Context<br/>• Transaction Coordination"]
        Models["597 Domain Models<br/>& 51 Enums"]
        ModelTypes["Model Types:<br/>• Entity Models<br/>• View Models (View*)<br/>• Parameter Models (Param*)<br/>• Interfaces (I*)"]
    end

    subgraph Data["Data Access Layer"]
        EF["Entity Framework ORM"]
        EFFeatures["EF Features:<br/>• LINQ Queries<br/>• Change Tracking<br/>• Transaction Management<br/>• Multi-tenant Filtering"]
        DB[("SQL Server<br/>Database")]
        DBFeatures["Database:<br/>• Multi-tenant Isolation<br/>• Encrypted Data<br/>• Audit Trail Tables"]
    end

    Presentation --> Business
    Business --> Data

    style Presentation fill:#e8f5e9,stroke:#4caf50
    style Business fill:#fff3e0,stroke:#ff9800
    style Data fill:#e3f2fd,stroke:#2196f3</div><h3>2.2 Architectural Principles</h3>
<p><strong>1. Separation of Concerns</strong>:</p>
<ul>
<li>Presentation layer handles HTTP and API concerns</li>
<li>Business logic layer enforces rules and workflows</li>
<li>Data access layer manages persistence</li>
</ul>
<p><strong>2. Single Responsibility</strong>:</p>
<ul>
<li>Each controller handles one domain entity or workflow</li>
<li>Each model represents one concept</li>
<li>Each service has one clear purpose</li>
</ul>
<p><strong>3. Dependency Inversion</strong>:</p>
<ul>
<li>Controllers depend on interfaces, not concrete implementations</li>
<li>Service layer abstracts data access</li>
<li>Pluggable components via interfaces</li>
</ul>
<p><strong>4. Open/Closed Principle</strong>:</p>
<ul>
<li>Extensible through inheritance and interfaces</li>
<li>Closed for modification through stable base classes</li>
<li>New features added without changing existing code</li>
</ul>
<p><strong>5. Interface Segregation</strong>:</p>
<ul>
<li>104+ interface definitions (I* models)</li>
<li>Clients depend only on interfaces they use</li>
<li>Small, focused interfaces over large monolithic ones</li>
</ul>
<hr>
<h2>3. Component Architecture</h2>
<h3>3.1 Project Structure</h3>
<p><strong>Carmen.NET Solution</strong> (28 projects):</p>
<div class="mermaid">graph TD
    Root["Carmen.NET/"]

    Root --> WebApi["Carmen.WebApi/<br/>API Layer (Main)"]
    Root --> Domain["Carmen.Domain/<br/>Domain Layer"]
    Root --> Business["Carmen.Business/<br/>Business Logic Layer"]
    Root --> Data["Carmen.Data/<br/>Data Access Layer"]
    Root --> Crypto["Carmen.Crypto/<br/>Security Library"]
    Root --> Common["Carmen.Common/<br/>Shared Utilities"]
    Root --> Tests["Carmen.Tests/<br/>Test Projects"]

    WebApi --> Controllers["Controllers/<br/>60 API Controllers"]
    WebApi --> Areas["Areas/<br/>Additional API areas"]
    WebApi --> AppStart["App_Start/<br/>Configuration"]
    WebApi --> WebConfig["Web.config<br/>API configuration"]

    Controllers --> Auth["Authentication/<br/>Login, Token"]
    Controllers --> AP["AP/<br/>Accounts Payable<br/>(7 controllers)"]
    Controllers --> AR["AR/<br/>Accounts Receivable<br/>(9 controllers)"]
    Controllers --> GL["GL/<br/>General Ledger<br/>(5 controllers)"]
    Controllers --> Asset["Asset/<br/>Asset Management<br/>(6 controllers)"]
    Controllers --> Income["Income/<br/>Income/Revenue<br/>(5 controllers)"]
    Controllers --> Admin["Admin/<br/>System Admin<br/>(15+ controllers)"]

    Domain --> DomainModels["Models/<br/>597 domain models"]
    Domain --> Enums["Enums/<br/>51 enumerations"]

    DomainModels --> Entities["Entities/<br/>Database entities"]
    DomainModels --> Views["Views/<br/>View models (View*)"]
    DomainModels --> Params["Params/<br/>Request models (Param*)"]
    DomainModels --> Interfaces["Interfaces/<br/>Interface definitions (I*)"]

    Business --> Services["Services/<br/>Business services"]
    Business --> Validators["Validators/<br/>Validation logic"]
    Business --> Workflows["Workflows/<br/>Workflow orchestration"]

    Data --> Context["Context/<br/>EF DbContext"]
    Data --> Repositories["Repositories/<br/>Data repositories"]
    Data --> Migrations["Migrations/<br/>Database migrations"]

    Crypto --> Encryption["Encryption/<br/>Encryption services"]
    Crypto --> Decryption["Decryption/<br/>Decryption services"]

    Common --> Helpers["Helpers/<br/>Helper utilities"]
    Common --> Extensions["Extensions/<br/>Extension methods"]
    Common --> Constants["Constants/<br/>Shared constants"]

    Tests --> Unit["Unit/<br/>Unit tests"]
    Tests --> Integration["Integration/<br/>Integration tests"]
    Tests --> APITests["API/<br/>API tests"]

    style Root fill:#e1f5ff,stroke:#0288d1
    style WebApi fill:#e8f5e9,stroke:#4caf50
    style Domain fill:#fff3e0,stroke:#ff9800
    style Business fill:#f3e5f5,stroke:#9c27b0
    style Data fill:#e3f2fd,stroke:#2196f3
    style Crypto fill:#fce4ec,stroke:#e91e63
    style Common fill:#fff9c4,stroke:#fbc02d
    style Tests fill:#e0f2f1,stroke:#009688</div><h3>3.2 Module Component Breakdown</h3>
<p><strong>Accounts Payable (AP) Module</strong>:</p>
<pre><code class="language-text">AP Module Components
│
├── Controllers (7)
│   ├── ApInvoiceController          (Order: 200) - Invoice management
│   ├── ApPaymentController          (Order: 210) - Payment processing
│   ├── ApWhtController              (Order: 220) - Withholding tax
│   ├── ApVendorController           (Order: 230) - Vendor management
│   ├── ApRequisitionController      (Order: 240) - Purchase requisition
│   ├── ApPurchaseOrderController    (Order: 250) - Purchase orders
│   └── ApReceivingController        (Order: 260) - Goods receiving
│
├── Models
│   ├── Entities (AP_INVOICE_H, AP_INVOICE_D, AP_PAYMENT, etc.)
│   ├── Views (ViewApInvoice, ViewApPayment, etc.)
│   └── Params (ParamApInvoice, ParamApPayment, etc.)
│
└── Database Tables
    ├── AP_INVOICE_H                 # Invoice header
    ├── AP_INVOICE_D                 # Invoice details
    ├── AP_PAYMENT                   # Payments
    ├── AP_WHT                       # Withholding tax
    └── VENDOR                       # Vendor master</code></pre><p><strong>Accounts Receivable (AR) Module</strong>:</p>
<pre><code class="language-text">AR Module Components
│
├── Controllers (9)
│   ├── ArInvoiceController          (Order: 300) - AR invoicing
│   ├── ArReceiptController          (Order: 310) - Receipt processing
│   ├── ArContractController         (Order: 320) - Contract management
│   ├── ArFolioController            (Order: 330) - Folio management
│   ├── ArCustomerController         (Order: 340) - Customer management
│   ├── ArDepositController          (Order: 350) - Deposit handling
│   ├── ArCreditNoteController       (Order: 360) - Credit notes
│   ├── ArDebitNoteController        (Order: 370) - Debit notes
│   └── ArWriteOffController         (Order: 380) - Write-offs
│
├── Models
│   ├── Entities (AR_INVOICE_H, AR_INVOICE_D, AR_RECEIPT, etc.)
│   ├── Views (ViewArInvoice, ViewArReceipt, etc.)
│   └── Params (ParamArInvoice, ParamArReceipt, etc.)
│
└── Database Tables
    ├── AR_INVOICE_H                 # Invoice header
    ├── AR_INVOICE_D                 # Invoice details
    ├── AR_RECEIPT                   # Receipts
    ├── AR_CONTRACT                  # Contracts
    ├── AR_FOLIO                     # Folios
    └── CUSTOMER                     # Customer master</code></pre><p><strong>General Ledger (GL) Module</strong>:</p>
<pre><code class="language-text">GL Module Components
│
├── Controllers (5)
│   ├── AccountCodeController        (Order: 400) - Chart of accounts
│   ├── GlJvController               (Order: 410) - Journal vouchers
│   ├── GlJvFrController             (Order: 420) - Foreign JV
│   ├── GlPeriodController           (Order: 430) - Period management
│   ├── GlAllocationJvController     (Order: 440) - Allocation JV
│   └── GlAmortizeController         (Order: 450) - Amortization
│
├── Models
│   ├── Entities (ACCOUNT_CODE, GL_JV_H, GL_JV_D, etc.)
│   ├── Views (ViewGlJv, ViewAccountCode, etc.)
│   └── Params (ParamGlJv, ParamGlPeriod, etc.)
│
└── Database Tables
    ├── ACCOUNT_CODE                 # Chart of accounts
    ├── GL_JV_H                      # Journal voucher header
    ├── GL_JV_D                      # Journal voucher details
    ├── GL_PERIOD                    # Accounting periods
    ├── GL_ALLOCATION_JV_H           # Allocation header
    └── GL_AMORTIZE                  # Amortization</code></pre><p><strong>Asset Management Module</strong>:</p>
<pre><code class="language-text">Asset Module Components
│
├── Controllers (6)
│   ├── AssetRegisterController      (Order: 500) - Asset register
│   ├── AssetCategoryController      (Order: 510) - Asset categories
│   ├── AssetDisposalController      (Order: 520) - Asset disposal
│   ├── AssetHistoryController       (Order: 530) - Asset history
│   ├── AssetLocationController      (Order: 540) - Asset locations
│   └── AssetDepartmentController    (Order: 550) - Asset departments
│
├── Models
│   ├── Entities (ASSET_REGISTER, ASSET_CATEGORY, etc.)
│   ├── Views (ViewAsset, ViewAssetDisposal, etc.)
│   └── Params (ParamAsset, ParamAssetDisposal, etc.)
│
└── Database Tables
    ├── ASSET_REGISTER               # Asset master
    ├── ASSET_CATEGORY               # Asset categories
    ├── ASSET_DISPOSAL               # Disposal records
    ├── ASSET_HISTORY                # Asset history
    ├── ASSET_LOCATION               # Asset locations
    └── ASSET_DEPARTMENT             # Asset departments</code></pre><p><strong>Income/Revenue Module</strong>:</p>
<pre><code class="language-text">Income Module Components
│
├── Controllers (5)
│   ├── IncomeInvoiceController      (Order: 600) - Income invoicing
│   ├── IncomeRevenueController      (Order: 610) - Revenue recognition
│   ├── IncomeProductController      (Order: 620) - Product management
│   ├── IncomeCategoryController     (Order: 630) - Income categories
│   └── IncomeSourceController       (Order: 640) - Income sources
│
├── Models
│   ├── Entities (INCOME_INVOICE, INCOME_REVENUE, etc.)
│   ├── Views (ViewIncomeInvoice, ViewIncomeRevenue, etc.)
│   └── Params (ParamIncomeInvoice, ParamIncomeRevenue, etc.)
│
└── Database Tables
    ├── INCOME_INVOICE_H             # Invoice header
    ├── INCOME_INVOICE_D             # Invoice details
    ├── INCOME_REVENUE               # Revenue records
    ├── INCOME_PRODUCT               # Product master
    ├── INCOME_CATEGORY              # Income categories
    └── INCOME_SOURCE                # Income sources</code></pre><hr>
<h2>4. Data Architecture</h2>
<h3>4.1 Data Model Overview</h3>
<p><strong>Total Models</strong>: 597<br><strong>Enumerations</strong>: 51<br><strong>Interfaces</strong>: 104+ (I* pattern)</p>
<p><strong>Model Categories</strong>:</p>
<ul>
<li><strong>Entity Models</strong>: Database-mapped entities</li>
<li><strong>View Models</strong>: API response DTOs (View*)</li>
<li><strong>Parameter Models</strong>: API request DTOs (Param*)</li>
<li><strong>Interface Models</strong>: Contracts and abstractions (I*)</li>
</ul>
<h3>4.2 Database Schema Overview</h3>
<p><strong>Core Entity Groups</strong>:</p>
<div class="mermaid">graph TD
    subgraph Master["1. Master Data Tables"]
        M1[USER]
        M2[TENANT]
        M3[COMPANY]
        M4[DEPARTMENT]
        M5[CURRENCY]
        M6[VENDOR]
        M7[CUSTOMER]
        M8[ACCOUNT_CODE]
    end

    subgraph Transaction["2. Transaction Tables"]
        T1[AP_INVOICE_H / AP_INVOICE_D]
        T2[AP_PAYMENT]
        T3[AR_INVOICE_H / AR_INVOICE_D]
        T4[AR_RECEIPT]
        T5[GL_JV_H / GL_JV_D]
        T6[ASSET_REGISTER]
        T7[INCOME_INVOICE_H / INCOME_INVOICE_D]
    end

    subgraph Config["3. Configuration Tables"]
        C1[PERMISSION]
        C2[WORKFLOW]
        C3[DIMENSION]
        C4[GL_PERIOD]
        C5[ASSET_CATEGORY]
    end

    subgraph Audit["4. Audit & System Tables"]
        A1[PROCESS_LOG]
        A2[USER_ACTIVITY_LOG]
        A3[AUDIT_TRAIL]
        A4[SYSTEM_CONFIG]
    end

    style Master fill:#e3f2fd,stroke:#1976d2,color:#000000
    style Transaction fill:#fff3e0,stroke:#f57c00,color:#000000
    style Config fill:#e8f5e9,stroke:#388e3c,color:#000000
    style Audit fill:#fce4ec,stroke:#c2185b,color:#000000</div><h3>4.3 Data Flow Architecture</h3>
<p><strong>Transaction to GL Posting Flow</strong>:</p>
<div class="mermaid">flowchart TD
    A[AP Invoice Created] --> B[AP_INVOICE_H Header<br/>AP_INVOICE_D Details]
    B --> C[GL Journal Generated]
    C --> D[GL_JV_H Header<br/>GL_JV_D Details]
    D --> E[DR: Expense Account<br/>CR: AP Payable Account]
    E --> F[ACCOUNT_CODE<br/>Balances Updated]

    style A fill:#e3f2fd,stroke:#1976d2
    style B fill:#fff3e0,stroke:#f57c00
    style C fill:#f3e5f5,stroke:#7b1fa2
    style D fill:#e8f5e9,stroke:#388e3c
    style E fill:#fce4ec,stroke:#c2185b
    style F fill:#e0f2f1,stroke:#00796b</div><p><strong>Multi-Tenant Data Flow</strong>:</p>
<div class="mermaid">flowchart TD
    A[User Request] --> B[Extract Tenant Context<br/>from Token]
    B --> C[FncBase.ApplyTenantIfUseTenant true]
    C --> D[Database Query<br/>with Tenant Filter]
    D --> E[WHERE TenantId = @CurrentTenant]
    E --> F[Return Only<br/>Tenant-Specific Data]

    style A fill:#e3f2fd,stroke:#1976d2
    style B fill:#fff3e0,stroke:#f57c00
    style C fill:#f3e5f5,stroke:#7b1fa2
    style D fill:#e8f5e9,stroke:#388e3c
    style E fill:#fce4ec,stroke:#c2185b
    style F fill:#e0f2f1,stroke:#00796b</div><h3>4.4 Database Relationships</h3>
<p><strong>Master-Detail Relationships</strong>:</p>
<ul>
<li>Invoice Header (1) ↔ Invoice Details (N)</li>
<li>GL JV Header (1) ↔ GL JV Details (N)</li>
<li>Asset Register (1) ↔ Asset History (N)</li>
<li>Income Invoice Header (1) ↔ Invoice Details (N)</li>
</ul>
<p><strong>Lookup Relationships</strong>:</p>
<ul>
<li>Transactions → ACCOUNT_CODE (GL account)</li>
<li>Transactions → VENDOR/CUSTOMER (party)</li>
<li>Transactions → DEPARTMENT (department)</li>
<li>Transactions → CURRENCY (currency code)</li>
</ul>
<p><strong>Workflow Relationships</strong>:</p>
<ul>
<li>Entity → WORKFLOW (approval workflow)</li>
<li>Entity → USER (approver)</li>
<li>Entity → STATUS (workflow status)</li>
</ul>
<hr>
<h2>5. Security Architecture</h2>
<h3>5.1 Security Layers</h3>
<p><strong>Layer 1: Network Security</strong>:</p>
<ul>
<li>HTTPS/TLS encryption</li>
<li>Firewall rules</li>
<li>Network segmentation</li>
</ul>
<p><strong>Layer 2: Application Security</strong>:</p>
<ul>
<li>Token-based authentication (JWT)</li>
<li>Role-based access control (RBAC)</li>
<li>Multi-tenant isolation</li>
<li>Input validation</li>
</ul>
<p><strong>Layer 3: Data Security</strong>:</p>
<ul>
<li>Encryption at rest (Carmen.Crypto)</li>
<li>Encryption in transit (HTTPS)</li>
<li>Database-level encryption</li>
<li>Sensitive data masking</li>
</ul>
<p><strong>Layer 4: Audit &amp; Compliance</strong>:</p>
<ul>
<li>Comprehensive logging</li>
<li>Audit trail</li>
<li>User activity tracking</li>
<li>Process logging</li>
</ul>
<h3>5.2 Authentication &amp; Authorization Flow</h3>
<div class="mermaid">sequenceDiagram
    participant Client
    participant API as Carmen.NET API

    Client->>API: 1. POST /api/login<br/>{username, password}
    Note over API: 2. Validate credentials<br/>Generate JWT token
    API-->>Client: 3. Return JWT token<br/>{token: "eyJ..."}

    Client->>API: 4. API Request<br/>Authorization: Bearer eyJ...
    Note over API: 5. Validate token<br/>Extract user/tenant<br/>Check permissions<br/>Apply tenant filter
    API-->>Client: 6. Return filtered data</div><h3>5.3 Permission Model</h3>
<p><strong>Permission Format</strong>: <code>{Module}.{Entity}</code></p>
<p><strong>Examples</strong>:</p>
<ul>
<li><code>AP.Invoice</code> - AP Invoice permissions</li>
<li><code>AR.Receipt</code> - AR Receipt permissions</li>
<li><code>GL.Journal</code> - GL Journal permissions</li>
<li><code>Asset.Register</code> - Asset Register permissions</li>
</ul>
<p><strong>Permission Actions</strong>:</p>
<ul>
<li><strong>View</strong>: Read/list permissions</li>
<li><strong>Create</strong>: Create new records</li>
<li><strong>Update</strong>: Modify existing records</li>
<li><strong>Delete</strong>: Delete records</li>
<li><strong>Approve</strong>: Approve workflow items</li>
<li><strong>Post</strong>: Post to GL</li>
<li><strong>Close</strong>: Close periods/transactions</li>
</ul>
<p><strong>Permission Check Pattern</strong>:</p>
<pre><code class="language-csharp">var permission = await FncPermission.GetPermissionInfoByPermissionNameAsync(&quot;AP.Invoice&quot;);

if (!permission.View)
    return this.JsonResultForbidden(&quot;&quot;, &quot;AP.Invoice&quot;, &quot;View&quot;);

if (!permission.Create)
    return this.JsonResultForbidden(&quot;&quot;, &quot;AP.Invoice&quot;, &quot;Create&quot;);</code></pre><hr>
<h2>6. Integration Architecture</h2>
<h3>6.1 API Integration</h3>
<p><strong>API Specifications</strong>:</p>
<ul>
<li><strong>Protocol</strong>: HTTPS REST</li>
<li><strong>Format</strong>: JSON</li>
<li><strong>Authentication</strong>: JWT Bearer Token</li>
<li><strong>Endpoints</strong>: 351+ across 60 controllers</li>
<li><strong>Documentation</strong>: Swagger/NSwag</li>
</ul>
<p><strong>API Endpoint Categories</strong>:</p>
<ul>
<li>Authentication (Login, Token)</li>
<li>Master Data (Vendor, Customer, Account)</li>
<li>Transactions (Invoice, Payment, Receipt)</li>
<li>Reports (Financial reports, analytics)</li>
<li>Utilities (Excel, File, Export)</li>
</ul>
<h3>6.2 File Integration</h3>
<p><strong>Supported File Formats</strong>:</p>
<ul>
<li><strong>Excel</strong>: Import/export master data and transactions</li>
<li><strong>CSV</strong>: Batch data import/export</li>
<li><strong>Banking Files</strong>: Payment files, bank statements</li>
<li><strong>WHT Files</strong>: Tax withholding file formats</li>
</ul>
<p><strong>File Processing Flow</strong>:</p>
<div class="mermaid">flowchart TD
    A[File Upload] --> B[Validate Format]
    B --> C[Parse Data]
    C --> D[Validate Business Rules]
    D --> E[Import with Transaction]
    E --> F[Generate Import Report]

    style A fill:#e3f2fd,stroke:#1976d2
    style B fill:#fff3e0,stroke:#f57c00
    style C fill:#f3e5f5,stroke:#7b1fa2
    style D fill:#e8f5e9,stroke:#388e3c
    style E fill:#fce4ec,stroke:#c2185b
    style F fill:#e0f2f1,stroke:#00796b</div><h3>6.3 External System Integration</h3>
<p><strong>Banking Integration</strong>:</p>
<ul>
<li>Payment file generation</li>
<li>Bank statement reconciliation</li>
<li>Direct debit/credit processing</li>
</ul>
<p><strong>Tax Integration</strong>:</p>
<ul>
<li>WHT file generation for tax authorities</li>
<li>Tax report submission</li>
<li>Compliance reporting</li>
</ul>
<p><strong>GL Integration</strong>:</p>
<ul>
<li>All modules post to GL automatically</li>
<li>GL journal voucher generation</li>
<li>Account balance updates</li>
</ul>
<hr>
<h2>7. Deployment Architecture</h2>
<h3>7.1 Deployment Model</h3>
<p><strong>Standard Deployment</strong>:</p>
<div class="mermaid">graph TB
    LB[Load Balancer]

    subgraph WebServers["Web Servers"]
        WS1[Web Server 1<br/>IIS/API]
        WS2[Web Server 2<br/>IIS/API]
    end

    subgraph AppLayer["Application Layer"]
        APP[Application Server<br/>Carmen.WebApi]
    end

    subgraph DataLayer["Database Layer"]
        DB[(Database Server<br/>SQL Server<br/>━━━━━━━━━━━<br/>• Primary DB<br/>• Replica DB read)]
    end

    LB --> WS1
    LB --> WS2
    WS1 --> APP
    WS2 --> APP
    APP --> DB

    style LB fill:#4a90e2,stroke:#2e5c8a,color:#ffffff
    style WS1 fill:#7cb342,stroke:#558b2f,color:#ffffff
    style WS2 fill:#7cb342,stroke:#558b2f,color:#ffffff
    style APP fill:#ff9800,stroke:#e65100,color:#ffffff
    style DB fill:#9c27b0,stroke:#6a1b9a,color:#ffffff</div><p><strong>Multi-Tenant Deployment</strong>:</p>
<ul>
<li><strong>Option 1</strong>: Shared database with tenant isolation</li>
<li><strong>Option 2</strong>: Separate schema per tenant</li>
<li><strong>Option 3</strong>: Separate database per tenant</li>
</ul>
<h3>7.2 Infrastructure Requirements</h3>
<p><strong>Web Server</strong>:</p>
<ul>
<li>IIS 8.0+ or Kestrel</li>
<li>.NET Framework 4.x runtime</li>
<li>Windows Server 2012+ or Linux</li>
</ul>
<p><strong>Application Server</strong>:</p>
<ul>
<li>ASP.NET Web API</li>
<li>Entity Framework</li>
<li>Carmen.NET assemblies</li>
</ul>
<p><strong>Database Server</strong>:</p>
<ul>
<li>SQL Server 2014+ (Standard or Enterprise)</li>
<li>Minimum 50 GB storage</li>
<li>Full-text search capability</li>
</ul>
<p><strong>Network</strong>:</p>
<ul>
<li>HTTPS/TLS 1.2+</li>
<li>Firewall configured for API access</li>
<li>VPN for administrative access</li>
</ul>
<h3>7.3 Scalability Considerations</h3>
<p><strong>Horizontal Scaling</strong>:</p>
<ul>
<li>Stateless API design (no server-side sessions)</li>
<li>Load balancer distribution</li>
<li>Database read replicas</li>
</ul>
<p><strong>Vertical Scaling</strong>:</p>
<ul>
<li>Increase server CPU/RAM</li>
<li>Database performance tuning</li>
<li>Caching strategies</li>
</ul>
<p><strong>Performance Targets</strong>:</p>
<ul>
<li>API response time: &lt;200ms (avg), &lt;500ms (P95)</li>
<li>Concurrent users: 100+ per server</li>
<li>Database queries: &lt;100ms (simple), &lt;500ms (complex)</li>
<li>File upload: 10 MB limit per request</li>
</ul>
<hr>
<h2>8. Technology Stack</h2>
<h3>8.1 Backend Technologies</h3>
<p><strong>Framework &amp; Runtime</strong>:</p>
<ul>
<li>.NET Framework 4.x</li>
<li>ASP.NET Web API 2.x</li>
<li>C# 7.0+</li>
</ul>
<p><strong>Data Access</strong>:</p>
<ul>
<li>Entity Framework 6.x</li>
<li>LINQ</li>
<li>SQL Server 2014+</li>
</ul>
<p><strong>Security</strong>:</p>
<ul>
<li>JWT (JSON Web Tokens)</li>
<li>Carmen.Crypto library</li>
<li>HTTPS/TLS</li>
</ul>
<p><strong>API Documentation</strong>:</p>
<ul>
<li>Swagger/Swashbuckle</li>
<li>NSwag</li>
</ul>
<p><strong>Logging</strong>:</p>
<ul>
<li>Custom logging framework (LogHttpRequest, LogHttpResult)</li>
<li>File-based logging (inferred)</li>
</ul>
<h3>8.2 Frontend Technologies (Inferred)</h3>
<p><strong>Web Client</strong>:</p>
<ul>
<li>HTML5/CSS3/JavaScript</li>
<li>jQuery or modern JS framework (React/Vue/Angular)</li>
<li>Bootstrap or similar UI framework</li>
</ul>
<p><strong>Excel Add-in</strong>:</p>
<ul>
<li>Office JavaScript API</li>
<li>VSTO (Visual Studio Tools for Office)</li>
</ul>
<p><strong>Mobile</strong> (if implemented):</p>
<ul>
<li>Xamarin or React Native</li>
<li>REST API consumption</li>
</ul>
<h3>8.3 Third-Party Libraries &amp; Services</h3>
<p><strong>Known Dependencies</strong>:</p>
<ul>
<li>Newtonsoft.Json (JSON serialization)</li>
<li>Entity Framework</li>
<li>Swagger/NSwag</li>
<li>(Additional dependencies from dependency analysis)</li>
</ul>
<hr>
<h2>9. Non-Functional Requirements</h2>
<h3>9.1 Performance</h3>
<p><strong>Response Time</strong>:</p>
<ul>
<li>API calls: &lt;200ms average, &lt;500ms P95</li>
<li>Database queries: &lt;100ms simple, &lt;500ms complex</li>
<li>File upload: Support up to 10 MB files</li>
<li>Report generation: &lt;5 seconds for standard reports</li>
</ul>
<p><strong>Throughput</strong>:</p>
<ul>
<li>100+ concurrent users per server</li>
<li>1000+ API requests per minute</li>
<li>Batch processing: 1000+ records per minute</li>
</ul>
<p><strong>Resource Usage</strong>:</p>
<ul>
<li>CPU: &lt;70% average utilization</li>
<li>Memory: &lt;4 GB per server instance</li>
<li>Database: &lt;50 GB per tenant (average)</li>
</ul>
<h3>9.2 Reliability</h3>
<p><strong>Availability</strong>:</p>
<ul>
<li>Target uptime: 99.9% (8.7 hours/year downtime)</li>
<li>Planned maintenance windows</li>
<li>Redundant servers and database replication</li>
</ul>
<p><strong>Data Integrity</strong>:</p>
<ul>
<li>ACID transactions</li>
<li>Database backups (daily full, hourly incremental)</li>
<li>Transaction rollback on failure</li>
</ul>
<p><strong>Error Handling</strong>:</p>
<ul>
<li>Graceful error responses</li>
<li>No data corruption on failure</li>
<li>Automatic retry for transient failures</li>
</ul>
<h3>9.3 Security</h3>
<p><strong>Authentication</strong>:</p>
<ul>
<li>Strong password policies (8+ characters, complexity)</li>
<li>Token expiration (configurable, default 60 minutes)</li>
<li>Account lockout after failed attempts</li>
</ul>
<p><strong>Authorization</strong>:</p>
<ul>
<li>Role-based access control (RBAC)</li>
<li>Granular permissions per module/entity</li>
<li>Multi-tenant data isolation</li>
</ul>
<p><strong>Data Protection</strong>:</p>
<ul>
<li>Encryption at rest (Carmen.Crypto)</li>
<li>Encryption in transit (HTTPS/TLS 1.2+)</li>
<li>Sensitive data masking in logs</li>
</ul>
<p><strong>Compliance</strong>:</p>
<ul>
<li>GDPR readiness (data protection, right to be forgotten)</li>
<li>SOC 2 alignment (access controls, audit logging)</li>
<li>Local tax compliance (WHT, financial reporting)</li>
</ul>
<h3>9.4 Maintainability</h3>
<p><strong>Code Quality</strong>:</p>
<ul>
<li>Consistent coding standards</li>
<li>Comprehensive error handling</li>
<li>Logging and diagnostics</li>
</ul>
<p><strong>Documentation</strong>:</p>
<ul>
<li>API documentation (Swagger)</li>
<li>System architecture documentation</li>
<li>Database schema documentation</li>
<li>User manuals and guides</li>
</ul>
<p><strong>Testing</strong>:</p>
<ul>
<li>Unit test coverage target: ≥80%</li>
<li>Integration tests for critical paths</li>
<li>API contract tests</li>
<li>Performance/load testing</li>
</ul>
<h3>9.5 Scalability</h3>
<p><strong>User Growth</strong>:</p>
<ul>
<li>Support 1000+ users per deployment</li>
<li>Linear scaling with hardware addition</li>
<li>Database sharding capability (multi-tenant)</li>
</ul>
<p><strong>Data Growth</strong>:</p>
<ul>
<li>Handle 10+ years of financial data</li>
<li>Archive and purge strategies</li>
<li>Database partitioning for large tables</li>
</ul>
<p><strong>Geographic Distribution</strong>:</p>
<ul>
<li>Multi-region deployment capability</li>
<li>Data residency compliance</li>
<li>Replication and synchronization</li>
</ul>
<hr>
<h2>10. Quality Attributes</h2>
<h3>10.1 Quality Attribute Scenarios</h3>
<p><strong>Availability Scenario</strong>:</p>
<pre><code class="language-text">Source: System monitoring
Stimulus: Server failure detected
Environment: Normal operations
Artifact: Web API server
Response: Failover to backup server
Response Measure: &lt;30 seconds downtime</code></pre><p><strong>Performance Scenario</strong>:</p>
<pre><code class="language-text">Source: User
Stimulus: API request for invoice list
Environment: Peak load (100 concurrent users)
Artifact: API endpoint
Response: Return invoice list
Response Measure: &lt;200ms average response time</code></pre><p><strong>Security Scenario</strong>:</p>
<pre><code class="language-text">Source: Unauthorized user
Stimulus: Attempt to access restricted endpoint
Environment: Production system
Artifact: Authorization layer
Response: Deny access, log attempt
Response Measure: 100% prevention, &lt;10ms overhead</code></pre><p><strong>Modifiability Scenario</strong>:</p>
<pre><code class="language-text">Source: Developer
Stimulus: Add new API endpoint
Environment: Development
Artifact: Controller layer
Response: Create new controller method
Response Measure: &lt;4 hours effort, no impact on existing endpoints</code></pre><hr>
<h2>11. Design Decisions &amp; Rationale</h2>
<h3>11.1 Architecture Decisions</h3>
<p><strong>Decision 1: 3-Tier Layered Architecture</strong></p>
<ul>
<li><strong>Rationale</strong>: Clear separation of concerns, maintainability, testability</li>
<li><strong>Trade-offs</strong>: Slight performance overhead vs. modularity</li>
<li><strong>Alternatives Considered</strong>: Microservices (too complex for current scale)</li>
</ul>
<p><strong>Decision 2: RESTful API</strong></p>
<ul>
<li><strong>Rationale</strong>: Industry standard, language-agnostic, scalable</li>
<li><strong>Trade-offs</strong>: Stateless design requires token management</li>
<li><strong>Alternatives Considered</strong>: SOAP (too heavyweight), GraphQL (unnecessary complexity)</li>
</ul>
<p><strong>Decision 3: Multi-Tenant with Tenant Column</strong></p>
<ul>
<li><strong>Rationale</strong>: Balance between isolation and resource efficiency</li>
<li><strong>Trade-offs</strong>: Shared database vs. complete isolation</li>
<li><strong>Alternatives Considered</strong>: Separate DB per tenant (higher cost), separate schema (migration complexity)</li>
</ul>
<p><strong>Decision 4: Token-Based Authentication (JWT)</strong></p>
<ul>
<li><strong>Rationale</strong>: Stateless, scalable, industry standard</li>
<li><strong>Trade-offs</strong>: Token size vs. server-side session management</li>
<li><strong>Alternatives Considered</strong>: Session-based auth (not scalable), OAuth2 (over-engineered for use case)</li>
</ul>
<p><strong>Decision 5: Entity Framework ORM</strong></p>
<ul>
<li><strong>Rationale</strong>: Productivity, LINQ support, change tracking</li>
<li><strong>Trade-offs</strong>: Performance overhead vs. raw SQL, learning curve</li>
<li><strong>Alternatives Considered</strong>: Dapper (less productive), raw ADO.NET (too low-level)</li>
</ul>
<h3>11.2 Technology Choices</h3>
<p><strong>.NET Framework vs. .NET Core</strong>:</p>
<ul>
<li><strong>Decision</strong>: .NET Framework 4.x</li>
<li><strong>Rationale</strong>: Mature ecosystem, enterprise support, Windows integration</li>
<li><strong>Future</strong>: Consider migration to .NET 6/8 for cross-platform and performance</li>
</ul>
<p><strong>SQL Server vs. Other RDBMS</strong>:</p>
<ul>
<li><strong>Decision</strong>: SQL Server</li>
<li><strong>Rationale</strong>: Enterprise features, .NET integration, mature tooling</li>
<li><strong>Trade-offs</strong>: Licensing cost vs. PostgreSQL/MySQL</li>
</ul>
<p><strong>Swagger/NSwag vs. Custom Documentation</strong>:</p>
<ul>
<li><strong>Decision</strong>: Swagger/NSwag</li>
<li><strong>Rationale</strong>: Auto-generated API docs, interactive testing, industry standard</li>
<li><strong>Trade-offs</strong>: Additional dependency vs. manual documentation</li>
</ul>
<hr>
<h2>12. Architecture Constraints</h2>
<h3>12.1 Technical Constraints</h3>
<ul>
<li>Must use .NET Framework 4.x (Windows compatibility requirement)</li>
<li>Must support SQL Server 2014+ (enterprise standard)</li>
<li>Must provide REST API (integration requirement)</li>
<li>Must support multi-tenancy (business requirement)</li>
<li>Must encrypt sensitive data (compliance requirement)</li>
</ul>
<h3>12.2 Business Constraints</h3>
<ul>
<li>Must support local accounting standards (Thailand, inferred)</li>
<li>Must generate WHT tax files (regulatory requirement)</li>
<li>Must maintain complete audit trail (compliance requirement)</li>
<li>Must support Excel integration (user requirement)</li>
<li>Must be multi-tenant (SaaS business model)</li>
</ul>
<h3>12.3 Organizational Constraints</h3>
<ul>
<li>Development team familiar with .NET/C#</li>
<li>Windows Server infrastructure</li>
<li>SQL Server licensing and expertise</li>
<li>Compliance with internal security policies</li>
</ul>
<hr>
<h2>13. Future Architecture Evolution</h2>
<h3>13.1 Short-Term Enhancements (6-12 months)</h3>
<p><strong>Performance Optimization</strong>:</p>
<ul>
<li>Implement response caching</li>
<li>Add database query optimization</li>
<li>Enable compression for API responses</li>
<li>Implement API rate limiting</li>
</ul>
<p><strong>Security Enhancements</strong>:</p>
<ul>
<li>Add two-factor authentication (2FA)</li>
<li>Implement token refresh mechanism</li>
<li>Add API request signing</li>
<li>Enhance password policies</li>
</ul>
<p><strong>Monitoring &amp; Observability</strong>:</p>
<ul>
<li>Add application performance monitoring (APM)</li>
<li>Implement centralized logging (ELK stack)</li>
<li>Add real-time dashboards</li>
<li>Set up alerting and notifications</li>
</ul>
<h3>13.2 Medium-Term Evolution (1-2 years)</h3>
<p><strong>Migration to .NET 6/8</strong>:</p>
<ul>
<li>Migrate from .NET Framework to .NET 6/8</li>
<li>Containerization with Docker</li>
<li>Kubernetes orchestration</li>
<li>Cross-platform deployment (Linux)</li>
</ul>
<p><strong>Microservices Consideration</strong>:</p>
<ul>
<li>Evaluate module extraction (AP, AR, GL as microservices)</li>
<li>Event-driven architecture with message queues</li>
<li>Service mesh for inter-service communication</li>
<li>API gateway pattern</li>
</ul>
<p><strong>Advanced Features</strong>:</p>
<ul>
<li>Machine learning for fraud detection</li>
<li>Predictive analytics for cash flow</li>
<li>Automated reconciliation</li>
<li>AI-powered invoice processing</li>
</ul>
<h3>13.3 Long-Term Vision (3-5 years)</h3>
<p><strong>Cloud-Native Architecture</strong>:</p>
<ul>
<li>Full cloud migration (Azure/AWS)</li>
<li>Serverless functions for batch processing</li>
<li>Managed database services</li>
<li>Auto-scaling and global distribution</li>
</ul>
<p><strong>Platform Ecosystem</strong>:</p>
<ul>
<li>Open API marketplace</li>
<li>Third-party integrations</li>
<li>Plugin architecture</li>
<li>Developer SDK and tools</li>
</ul>
<p><strong>Advanced Capabilities</strong>:</p>
<ul>
<li>Real-time collaboration features</li>
<li>Mobile-first experience</li>
<li>Blockchain for audit trail</li>
<li>IoT integration for asset tracking</li>
</ul>
<hr>
<h2>14. Architecture Governance</h2>
<h3>14.1 Architecture Review Process</h3>
<p><strong>Review Triggers</strong>:</p>
<ul>
<li>New module development</li>
<li>Major feature additions</li>
<li>Performance/security issues</li>
<li>Technology stack changes</li>
</ul>
<p><strong>Review Checklist</strong>:</p>
<ul>
<li>✅ Alignment with architecture principles</li>
<li>✅ Security review and threat modeling</li>
<li>✅ Performance impact assessment</li>
<li>✅ Scalability considerations</li>
<li>✅ Documentation completeness</li>
<li>✅ Testing strategy</li>
</ul>
<h3>14.2 Architecture Compliance</h3>
<p><strong>Standards Enforcement</strong>:</p>
<ul>
<li>Code review process</li>
<li>Automated code quality checks</li>
<li>Security scanning (SAST/DAST)</li>
<li>Performance testing</li>
</ul>
<p><strong>Metrics &amp; KPIs</strong>:</p>
<ul>
<li>API response time percentiles (P50, P95, P99)</li>
<li>Error rate per endpoint</li>
<li>Security vulnerability count</li>
<li>Code coverage percentage</li>
<li>Technical debt ratio</li>
</ul>
<hr>
<h2>Conclusion</h2>
<p>Carmen.NET implements a <strong>well-structured 3-tier architecture</strong> with:</p>
<p>✅ <strong>Clear Separation</strong>: Presentation, Business Logic, Data Access layers<br>✅ <strong>Strong Security</strong>: Multi-layer security with authentication, authorization, encryption<br>✅ <strong>Multi-Tenant</strong>: Complete tenant isolation across all layers<br>✅ <strong>Scalable Design</strong>: RESTful API, stateless architecture, horizontal scaling capability<br>✅ <strong>Comprehensive Coverage</strong>: 11 modules, 351+ endpoints, 597 models supporting complete financial operations<br>✅ <strong>Maintainability</strong>: Consistent patterns, extensive logging, comprehensive documentation</p>
<p><strong>Architecture Maturity</strong>: <strong>STRONG</strong> - Production-ready with clear evolution path for cloud-native and microservices transformation.</p>
<hr>
<p><strong>Document Generated</strong>: 2025-10-06<br><strong>Analysis Phase</strong>: Phase 2 - Architecture &amp; Data Modeling<br><strong>Status</strong>: COMPLETE</p>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        // Initialize Mermaid
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
        });

        // Render all mermaid diagrams
        document.addEventListener('DOMContentLoaded', function() {
            const mermaidElements = document.querySelectorAll('.mermaid');
            console.log('Found ' + mermaidElements.length + ' mermaid diagrams');

            mermaidElements.forEach((element, index) => {
                element.id = 'mermaid-' + index;
            });

            if (mermaidElements.length > 0) {
                mermaid.run();
            }
        });
    </script>
</body>
</html>