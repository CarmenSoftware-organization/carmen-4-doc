<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Invoice Workflow - Carmen.NET Documentation</title>
    <link rel="stylesheet" href="/public/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #212121;
            background: #f5f5f5;
            padding: 0;
            margin: 0;
        }
        .doc-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .doc-header {
            border-bottom: 2px solid #1976D2;
            padding-bottom: 16px;
            margin-bottom: 32px;
        }
        .doc-header h1 {
            margin: 0;
            color: #1976D2;
        }
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #1976D2;
            text-decoration: none;
            margin-bottom: 16px;
            font-weight: 600;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        .doc-content h1 {
            font-size: 2.5em;
            margin-top: 0;
            margin-bottom: 0.5em;
            color: #1f2937;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.3em;
        }
        .doc-content h2 {
            font-size: 2em;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            color: #1f2937;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.3em;
        }
        .doc-content h3 {
            font-size: 1.5em;
            margin-top: 1.2em;
            margin-bottom: 0.5em;
            color: #374151;
        }
        .doc-content h4 {
            font-size: 1.25em;
            margin-top: 1em;
            margin-bottom: 0.5em;
            color: #4b5563;
        }
        .doc-content p {
            line-height: 1.7;
            margin-bottom: 1em;
            color: #374151;
        }
        .doc-content ul, .doc-content ol {
            margin-bottom: 1em;
            padding-left: 2em;
        }
        .doc-content li {
            margin-bottom: 0.5em;
            line-height: 1.7;
        }
        .doc-content code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #e11d48;
        }
        .doc-content pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 1em;
        }
        .doc-content pre code {
            background: none;
            padding: 0;
            color: #f9fafb;
        }
        .doc-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1em;
        }
        .doc-content th, .doc-content td {
            border: 1px solid #e5e7eb;
            padding: 12px;
            text-align: left;
        }
        .doc-content th {
            background: #f9fafb;
            font-weight: 600;
        }
        .doc-content blockquote {
            border-left: 4px solid #3b82f6;
            padding-left: 16px;
            margin-left: 0;
            color: #6b7280;
            font-style: italic;
        }
        .doc-content a {
            color: #3b82f6;
            text-decoration: none;
        }
        .doc-content a:hover {
            text-decoration: underline;
        }
        .doc-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 1em 0;
        }
        .mermaid {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin: 1em 0;
            text-align: center;
            overflow-x: auto;
        }
        .mermaid svg {
            max-width: 100%;
            height: auto;
        }
        @media (max-width: 768px) {
            .doc-container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="doc-container">
        <a href="/public/index.html" class="back-link">
            <i class="fas fa-arrow-left"></i>
            Back to Documentation
        </a>
        <div class="doc-header">
            <h1>AR Invoice Workflow</h1>
        </div>
        <div class="doc-content">
            <h1>AR Invoice Workflow</h1>
<h2>Overview</h2>
<p>The AR Invoice workflow manages the complete lifecycle of customer invoices from creation through payment collection, including billing approval workflows and GL posting.</p>
<h2>Workflow States</h2>
<div class="mermaid">stateDiagram-v2
    [*] --> Draft
    Draft --> PendingApproval: Submit for Approval
    Draft --> Draft: Save
    Draft --> Cancelled: Cancel

    PendingApproval --> Approved: Approve
    PendingApproval --> Rejected: Reject
    PendingApproval --> Draft: Return for Revision

    Rejected --> Draft: Revise
    Rejected --> Cancelled: Cancel

    Approved --> Posted: Post to GL

    Posted --> PartiallyCollected: Partial Receipt
    Posted --> FullyCollected: Full Receipt
    Posted --> Written Off: Write-off

    PartiallyCollected --> FullyCollected: Final Receipt
    PartiallyCollected --> Written Off: Write-off Balance

    FullyCollected --> [*]
    Written Off --> [*]
    Cancelled --> [*]</div><h2>Status Codes</h2>
<table>
<thead>
<tr>
<th>Status</th>
<th>Value</th>
<th>Description</th>
<th>Allowed Actions</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Draft</strong></td>
<td>0</td>
<td>Initial creation, data entry in progress</td>
<td>Edit, Submit, Delete, Cancel</td>
</tr>
<tr>
<td><strong>Pending Approval</strong></td>
<td>2</td>
<td>Submitted for approval</td>
<td>Approve, Reject, Return</td>
</tr>
<tr>
<td><strong>Approved</strong></td>
<td>3</td>
<td>Approved by authorized user</td>
<td>Post to GL</td>
</tr>
<tr>
<td><strong>Rejected</strong></td>
<td>4</td>
<td>Rejected during approval</td>
<td>Revise, Cancel</td>
</tr>
<tr>
<td><strong>Posted</strong></td>
<td>1</td>
<td>Posted to General Ledger</td>
<td>Create Receipt, Write-off</td>
</tr>
<tr>
<td><strong>Partially Collected</strong></td>
<td>5</td>
<td>Some payment received</td>
<td>Create Receipt, Write-off</td>
</tr>
<tr>
<td><strong>Fully Collected</strong></td>
<td>6</td>
<td>Completely paid</td>
<td>View Only</td>
</tr>
<tr>
<td><strong>Written Off</strong></td>
<td>7</td>
<td>Balance written off</td>
<td>View Only</td>
</tr>
<tr>
<td><strong>Cancelled</strong></td>
<td>9</td>
<td>Cancelled/Voided</td>
<td>View Only</td>
</tr>
</tbody></table>
<h2>Workflow Diagram</h2>
<div class="mermaid">flowchart TD
    Start([Start: Create Invoice]) --> CheckSource{Invoice<br/>Source?}

    CheckSource -->|Manual| EnterData[Enter Invoice Data]
    CheckSource -->|Contract| SelectContract[Select AR Contract]
    CheckSource -->|Folio| SelectFolio[Select Folio Items]

    SelectContract --> GenerateFromContract[Generate Invoice from Contract]
    SelectFolio --> GenerateFromFolio[Generate Invoice from Folio]

    GenerateFromContract --> EnterData
    GenerateFromFolio --> EnterData

    EnterData --> ValidateData{Validation<br/>Passed?}

    ValidateData -->|No| ShowErrors[Show Validation Errors]
    ShowErrors --> EnterData

    ValidateData -->|Yes| CalculateTax[Calculate VAT/Tax]
    CalculateTax --> SaveDraft[Save as Draft<br/>Status = 0]

    SaveDraft --> CheckSubmit{User Action?}

    CheckSubmit -->|Save| SaveDraft
    CheckSubmit -->|Submit| CheckPermission{Has Submit<br/>Permission?}
    CheckSubmit -->|Cancel| CancelInvoice[Cancel Invoice<br/>Status = 9]

    CheckPermission -->|No| Forbidden[Permission Denied]
    CheckPermission -->|Yes| SubmitApproval[Submit for Approval<br/>Status = 2]

    SubmitApproval --> NotifyApprover[Notify Approver]
    NotifyApprover --> WaitApproval[Wait for Approval]

    WaitApproval --> ApproverAction{Approver<br/>Decision?}

    ApproverAction -->|Approve| CheckApprovePermission{Has Approve<br/>Permission?}
    ApproverAction -->|Reject| RejectInvoice[Reject Invoice<br/>Status = 4]
    ApproverAction -->|Return| ReturnDraft[Return to Draft<br/>Status = 0]

    CheckApprovePermission -->|No| Forbidden
    CheckApprovePermission -->|Yes| ApproveInvoice[Approve Invoice<br/>Status = 3]

    ApproveInvoice --> GenerateInvoiceDoc[Generate Invoice Document]
    GenerateInvoiceDoc --> ReadyPost[Ready for GL Posting]

    ReadyPost --> PostAction{User Action?}

    PostAction -->|Post to GL| CheckPostPermission{Has Post<br/>Permission?}

    CheckPostPermission -->|No| Forbidden
    CheckPostPermission -->|Yes| ValidateAccounts{GL Accounts<br/>Valid?}

    ValidateAccounts -->|No| ShowAccountError[Show Account Errors]
    ValidateAccounts -->|Yes| CreateGLJV[Create GL Journal Voucher]

    CreateGLJV --> PostGLEntries[Post GL Entries:<br/>DR: AR Receivable<br/>CR: Revenue<br/>CR: VAT Payable]

    PostGLEntries --> UpdateStatus[Update Status<br/>Status = 1 Posted]
    UpdateStatus --> SendToCustomer[Send Invoice to Customer]

    SendToCustomer --> WaitPayment[Wait for Payment]

    WaitPayment --> PaymentAction{Payment<br/>Received?}

    PaymentAction -->|Partial| PartialCollect[Partially Collected<br/>Status = 5]
    PaymentAction -->|Full| FullCollect[Fully Collected<br/>Status = 6]
    PaymentAction -->|Write-off| WriteOff[Write-off Balance<br/>Status = 7]

    PartialCollect --> WaitPayment

    FullCollect --> End([End])
    WriteOff --> End
    CancelInvoice --> End
    RejectInvoice --> End</div><h2>Business Rules</h2>
<h3>Validation Rules</h3>
<ol>
<li><p><strong>Required Fields</strong>:</p>
<ul>
<li>Invoice Number</li>
<li>Invoice Date</li>
<li>Customer Code</li>
<li>Due Date</li>
<li>Invoice Amount &gt; 0</li>
<li>At least one invoice line item</li>
</ul>
</li>
<li><p><strong>Business Rules</strong>:</p>
<ul>
<li>Invoice Date cannot be in the future</li>
<li>Due Date must be &gt;= Invoice Date</li>
<li>Invoice Amount must equal sum of line items + tax</li>
<li>Customer must be active</li>
<li>GL Period must be open for invoice date</li>
<li>Duplicate invoice numbers not allowed (per customer)</li>
<li>Credit limit check (optional, configurable)</li>
</ul>
</li>
<li><p><strong>Line Item Rules</strong>:</p>
<ul>
<li>Each line must have valid GL Revenue Account Code</li>
<li>Line amount must be &gt; 0</li>
<li>Total of all lines must equal header amount (before tax)</li>
<li>Unit price and quantity must be consistent</li>
</ul>
</li>
</ol>
<h3>Permission Requirements</h3>
<table>
<thead>
<tr>
<th>Action</th>
<th>Permission</th>
<th>Permission Code</th>
</tr>
</thead>
<tbody><tr>
<td><strong>View</strong></td>
<td>View permission</td>
<td><code>AR.Invoice.View</code></td>
</tr>
<tr>
<td><strong>Create</strong></td>
<td>Create permission</td>
<td><code>AR.Invoice.Create</code></td>
</tr>
<tr>
<td><strong>Update</strong></td>
<td>Update permission</td>
<td><code>AR.Invoice.Update</code></td>
</tr>
<tr>
<td><strong>Delete</strong></td>
<td>Delete permission</td>
<td><code>AR.Invoice.Delete</code></td>
</tr>
<tr>
<td><strong>Submit</strong></td>
<td>Create permission</td>
<td><code>AR.Invoice.Create</code></td>
</tr>
<tr>
<td><strong>Approve</strong></td>
<td>Approve permission</td>
<td><code>AR.Invoice.Approve</code></td>
</tr>
<tr>
<td><strong>Reject</strong></td>
<td>Approve permission</td>
<td><code>AR.Invoice.Approve</code></td>
</tr>
<tr>
<td><strong>Post</strong></td>
<td>Post permission</td>
<td><code>AR.Invoice.Post</code></td>
</tr>
</tbody></table>
<h3>VAT/Tax Handling</h3>
<p>If invoice subject to VAT:</p>
<ol>
<li>Calculate VAT based on VAT rate and type</li>
<li>Create VAT record linked to invoice</li>
<li>GL posting includes VAT payable</li>
<li>VAT filing integration for tax authority</li>
</ol>
<p><strong>GL Posting with VAT</strong>:</p>
<pre><code class="language-text">DR: AR Receivable (gross amount)           11,700.00
CR: Revenue Account                        10,000.00
CR: VAT Payable (17%)                       1,700.00</code></pre><h2>Multi-Tenant Isolation</h2>
<p>All invoice operations enforce tenant isolation:</p>
<ul>
<li><code>FncBase.ApplyTenantIfUseTenant(useTenant)</code> applied to all queries</li>
<li>Users can only see invoices for their assigned tenant(s)</li>
<li>Cross-tenant data leakage prevented at database level</li>
</ul>
<h2>Approval Workflow</h2>
<h3>Approval Hierarchy</h3>
<p>Configurable approval rules based on:</p>
<ul>
<li>Invoice amount thresholds</li>
<li>Customer category</li>
<li>GL revenue account category</li>
<li>Department</li>
</ul>
<p><strong>Example Approval Matrix</strong>:</p>
<table>
<thead>
<tr>
<th>Amount Range</th>
<th>Approver Level</th>
<th>Required</th>
</tr>
</thead>
<tbody><tr>
<td>$0 - $5,000</td>
<td>AR Clerk</td>
<td>Optional</td>
</tr>
<tr>
<td>$5,001 - $25,000</td>
<td>AR Manager</td>
<td>Required</td>
</tr>
<tr>
<td>$25,001 - $100,000</td>
<td>Finance Manager</td>
<td>Required</td>
</tr>
<tr>
<td>$100,001+</td>
<td>CFO</td>
<td>Required</td>
</tr>
</tbody></table>
<h3>Approval Notifications</h3>
<ul>
<li>Email notification to approver when submitted</li>
<li>Reminder emails for pending approvals (configurable)</li>
<li>Notification to creator when approved/rejected</li>
<li>Alert to AR team when invoice posted</li>
</ul>
<h2>GL Posting</h2>
<h3>Standard GL Entry</h3>
<pre><code class="language-text">DR: AR Receivable Account                  XXX.XX
CR: Revenue Account (from invoice lines)   XXX.XX</code></pre><h3>With VAT</h3>
<pre><code class="language-text">DR: AR Receivable Account                  XXX.XX
CR: Revenue Account                        XXX.XX
CR: VAT Payable                             XX.XX</code></pre><h3>Multiple Revenue Categories</h3>
<pre><code class="language-text">DR: AR Receivable Account                  XXX.XX
CR: Product Revenue                        XXX.XX
CR: Service Revenue                        XXX.XX
CR: VAT Payable                             XX.XX</code></pre><h2>Invoice Sources</h2>
<h3>Manual Invoice</h3>
<ul>
<li>Direct data entry by AR staff</li>
<li>Line-by-line item entry</li>
<li>Manual calculation with validation</li>
</ul>
<h3>Contract-Based Invoice</h3>
<ul>
<li>Generated from AR Contract</li>
<li>Automatic billing based on contract terms</li>
<li>Recurring invoice support (monthly, quarterly, annual)</li>
<li>Contract milestone billing</li>
</ul>
<h3>Folio-Based Invoice</h3>
<ul>
<li>Generated from AR Folio items</li>
<li>Consolidate multiple charges</li>
<li>Hotel/hospitality billing patterns</li>
<li>Service charge aggregation</li>
</ul>
<h2>Integration Points</h2>
<h3>Upstream</h3>
<ul>
<li><strong>AR Contract</strong>: Invoice generated from contract terms</li>
<li><strong>AR Folio</strong>: Invoice generated from folio charges</li>
<li><strong>Customer Master</strong>: Validates customer exists and is active</li>
<li><strong>Product/Service Master</strong>: Validates items and pricing</li>
</ul>
<h3>Downstream</h3>
<ul>
<li><strong>AR Receipt</strong>: Invoice available for payment receipt</li>
<li><strong>AR Aging</strong>: Invoice aging and collection tracking</li>
<li><strong>GL</strong>: Journal vouchers posted to General Ledger</li>
<li><strong>Revenue Recognition</strong>: Revenue reporting and analysis</li>
<li><strong>Tax Filing</strong>: VAT/tax records for authority submission</li>
</ul>
<h2>Credit Management</h2>
<h3>Credit Limit Check</h3>
<p>Optional credit limit validation before posting:</p>
<ol>
<li>Calculate customer outstanding balance</li>
<li>Add new invoice amount</li>
<li>Compare against credit limit</li>
<li>Warning if exceeds limit (may block posting based on configuration)</li>
</ol>
<h3>Credit Terms</h3>
<ul>
<li>Payment terms definition (Net 30, Net 60, etc.)</li>
<li>Early payment discount configuration</li>
<li>Late payment penalty calculation</li>
<li>Automatic aging category assignment</li>
</ul>
<h2>Invoice Adjustments</h2>
<h3>Credit Note</h3>
<ul>
<li>Reduces invoice balance</li>
<li>Can be partial or full credit</li>
<li>Requires approval workflow</li>
<li>Creates reversing GL entries</li>
</ul>
<h3>Debit Note</h3>
<ul>
<li>Increases invoice balance</li>
<li>Additional charges or corrections</li>
<li>Requires approval workflow</li>
<li>Creates additional GL entries</li>
</ul>
<h2>Error Handling</h2>
<h3>Common Errors</h3>
<table>
<thead>
<tr>
<th>Error</th>
<th>Cause</th>
<th>Resolution</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Period Closed</strong></td>
<td>GL period is closed</td>
<td>Change invoice date or reopen period</td>
</tr>
<tr>
<td><strong>Duplicate Invoice</strong></td>
<td>Invoice number exists for customer</td>
<td>Use different invoice number</td>
</tr>
<tr>
<td><strong>Invalid Account</strong></td>
<td>GL revenue account invalid</td>
<td>Use valid account code</td>
</tr>
<tr>
<td><strong>Inactive Customer</strong></td>
<td>Customer is inactive</td>
<td>Activate customer or select different customer</td>
</tr>
<tr>
<td><strong>Validation Failed</strong></td>
<td>Required data missing</td>
<td>Complete all required fields</td>
</tr>
<tr>
<td><strong>Permission Denied</strong></td>
<td>User lacks permission</td>
<td>Request permission from administrator</td>
</tr>
<tr>
<td><strong>Credit Limit Exceeded</strong></td>
<td>Invoice exceeds customer credit limit</td>
<td>Request credit limit increase or split invoice</td>
</tr>
</tbody></table>
<h2>API Endpoints</h2>
<table>
<thead>
<tr>
<th>Endpoint</th>
<th>Method</th>
<th>Purpose</th>
<th>Permission</th>
</tr>
</thead>
<tbody><tr>
<td><code>/api/ar/invoice/list</code></td>
<td>GET</td>
<td>List invoices</td>
<td>View</td>
</tr>
<tr>
<td><code>/api/ar/invoice/{id}</code></td>
<td>GET</td>
<td>Get invoice details</td>
<td>View</td>
</tr>
<tr>
<td><code>/api/ar/invoice/create</code></td>
<td>POST</td>
<td>Create new invoice</td>
<td>Create</td>
</tr>
<tr>
<td><code>/api/ar/invoice/update</code></td>
<td>PUT</td>
<td>Update invoice</td>
<td>Update</td>
</tr>
<tr>
<td><code>/api/ar/invoice/delete/{id}</code></td>
<td>DELETE</td>
<td>Delete invoice</td>
<td>Delete</td>
</tr>
<tr>
<td><code>/api/ar/invoice/submit/{id}</code></td>
<td>POST</td>
<td>Submit for approval</td>
<td>Create</td>
</tr>
<tr>
<td><code>/api/ar/invoice/approve/{id}</code></td>
<td>POST</td>
<td>Approve invoice</td>
<td>Approve</td>
</tr>
<tr>
<td><code>/api/ar/invoice/reject/{id}</code></td>
<td>POST</td>
<td>Reject invoice</td>
<td>Approve</td>
</tr>
<tr>
<td><code>/api/ar/invoice/post/{id}</code></td>
<td>POST</td>
<td>Post to GL</td>
<td>Post</td>
</tr>
<tr>
<td><code>/api/ar/invoice/generate-pdf/{id}</code></td>
<td>GET</td>
<td>Generate invoice PDF</td>
<td>View</td>
</tr>
</tbody></table>
<h2>Reporting</h2>
<h3>Available Reports</h3>
<ol>
<li><strong>AR Invoice Register</strong>: All invoices with details</li>
<li><strong>AR Aging</strong>: Aging by due date (30/60/90/90+ days)</li>
<li><strong>Revenue Analysis</strong>: Revenue by product/service/customer</li>
<li><strong>Approval Status Report</strong>: Pending approvals by approver</li>
<li><strong>Posted Invoices Report</strong>: GL posting details</li>
<li><strong>Customer Invoice Summary</strong>: Summary by customer</li>
<li><strong>VAT Report</strong>: VAT details for filing</li>
<li><strong>Collection Efficiency</strong>: DSO and collection metrics</li>
</ol>
<h2>Best Practices</h2>
<ol>
<li><p><strong>Invoice Creation</strong>:</p>
<ul>
<li>Generate invoices promptly per contract terms</li>
<li>Verify pricing and discounts before posting</li>
<li>Attach supporting documents (contracts, delivery notes)</li>
<li>Use consistent invoice numbering</li>
</ul>
</li>
<li><p><strong>Approval</strong>:</p>
<ul>
<li>Review invoices within SLA (e.g., 1 business day)</li>
<li>Verify customer credit status before approval</li>
<li>Document rejection reasons clearly</li>
<li>Monitor high-value invoices</li>
</ul>
</li>
<li><p><strong>GL Posting</strong>:</p>
<ul>
<li>Post invoices in correct accounting period</li>
<li>Verify GL revenue accounts before posting</li>
<li>Review GL entries after posting</li>
<li>Match revenue recognition principles</li>
</ul>
</li>
<li><p><strong>Collection</strong>:</p>
<ul>
<li>Send invoices immediately after posting</li>
<li>Follow up on overdue invoices per aging schedule</li>
<li>Monitor Days Sales Outstanding (DSO)</li>
<li>Escalate collection issues promptly</li>
</ul>
</li>
<li><p><strong>Customer Service</strong>:</p>
<ul>
<li>Respond to invoice queries within 24 hours</li>
<li>Provide detailed invoice breakdown when requested</li>
<li>Process credit notes promptly for valid disputes</li>
<li>Maintain professional communication</li>
</ul>
</li>
</ol>
<hr>
<p><strong>Document Version</strong>: 1.0<br><strong>Last Updated</strong>: 2025-10-06<br><strong>Status</strong>: Phase 3 - Business Logic &amp; Workflow Analysis</p>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        // Initialize Mermaid
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
        });

        // Render all mermaid diagrams
        document.addEventListener('DOMContentLoaded', function() {
            const mermaidElements = document.querySelectorAll('.mermaid');
            console.log('Found ' + mermaidElements.length + ' mermaid diagrams');

            mermaidElements.forEach((element, index) => {
                element.id = 'mermaid-' + index;
            });

            if (mermaidElements.length > 0) {
                mermaid.run();
            }
        });
    </script>
</body>
</html>